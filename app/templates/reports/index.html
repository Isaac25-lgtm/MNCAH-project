{% extends "base.html" %}

{% block title %}Reports - MOH MNCAH Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 text-primary mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        MNCAH Reports Generator
                    </h1>
                    <p class="text-muted mt-1">Generate comprehensive reports for Ministry of Health MNCAH indicators</p>
                </div>
                <div>
                    <a href="{{ url_for('dashboard.index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Types Cards -->
    <div class="row mb-4">
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow h-100 report-card" onclick="selectReportType('comprehensive')">
                <div class="card-header bg-primary text-white text-center">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <h5 class="mb-0">Comprehensive Report</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Complete MNCAH analysis covering all 22 indicators across ANC, Intrapartum, and PNC categories.</p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>All 9 ANC indicators</li>
                        <li><i class="fas fa-check text-success me-2"></i>All 9 Intrapartum indicators</li>
                        <li><i class="fas fa-check text-success me-2"></i>All 4 PNC indicators</li>
                        <li><i class="fas fa-check text-success me-2"></i>Executive summary</li>
                        <li><i class="fas fa-check text-success me-2"></i>Recommendations</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <span class="badge bg-primary">Most Popular</span>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow h-100 report-card" onclick="selectReportType('category')">
                <div class="card-header bg-success text-white text-center">
                    <i class="fas fa-layer-group fa-2x mb-2"></i>
                    <h5 class="mb-0">Category-Specific Report</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Focused analysis on specific MNCAH category with detailed indicators breakdown.</p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Choose ANC, Intrapartum, or PNC</li>
                        <li><i class="fas fa-check text-success me-2"></i>Detailed indicator analysis</li>
                        <li><i class="fas fa-check text-success me-2"></i>Trend analysis</li>
                        <li><i class="fas fa-check text-success me-2"></i>Performance benchmarking</li>
                        <li><i class="fas fa-check text-success me-2"></i>Action recommendations</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <span class="badge bg-success">Detailed Focus</span>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow h-100 report-card" onclick="selectReportType('facility')">
                <div class="card-header bg-info text-white text-center">
                    <i class="fas fa-hospital fa-2x mb-2"></i>
                    <h5 class="mb-0">Facility Performance Report</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Individual facility performance analysis with comparative benchmarking.</p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Single facility focus</li>
                        <li><i class="fas fa-check text-success me-2"></i>Historical performance trends</li>
                        <li><i class="fas fa-check text-success me-2"></i>District/national comparison</li>
                        <li><i class="fas fa-check text-success me-2"></i>Data quality assessment</li>
                        <li><i class="fas fa-check text-success me-2"></i>Improvement recommendations</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <span class="badge bg-info">Facility-Focused</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Configuration Form -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Report Configuration</h6>
                </div>
                <div class="card-body">
                    <form id="reportForm">
                        {{ csrf_token() }}
                        <input type="hidden" id="reportType" name="report_type" value="">
                        
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label for="reportTitle" class="form-label">Report Title</label>
                                    <input type="text" class="form-control" id="reportTitle" name="report_title" 
                                           placeholder="Enter custom report title (optional)">
                                    <div class="form-text">Leave blank to use default title based on report type</div>
                                </div>

                                <div class="mb-3">
                                    <label for="reportPeriod" class="form-label">Reporting Period <span class="text-danger">*</span></label>
                                    <select class="form-select" id="reportPeriod" name="report_period" required>
                                        <option value="">Select period...</option>
                                        <option value="current_month">Current Month</option>
                                        <option value="current_quarter">Current Quarter</option>
                                        <option value="current_year">Current Year</option>
                                        <option value="last_month">Last Month</option>
                                        <option value="last_quarter">Last Quarter</option>
                                        <option value="last_year">Last Year</option>
                                        <option value="custom">Custom Date Range</option>
                                    </select>
                                </div>

                                <div class="mb-3" id="customDateRange" style="display: none;">
                                    <label class="form-label">Custom Date Range</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="date" class="form-control" id="startDate" name="start_date">
                                            <small class="text-muted">Start Date</small>
                                        </div>
                                        <div class="col-6">
                                            <input type="date" class="form-control" id="endDate" name="end_date">
                                            <small class="text-muted">End Date</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label for="outputFormat" class="form-label">Output Format <span class="text-danger">*</span></label>
                                    <select class="form-select" id="outputFormat" name="output_format" required>
                                        <option value="">Select format...</option>
                                        <option value="pdf">PDF Report</option>
                                        <option value="excel">Excel Workbook</option>
                                        <option value="both">Both PDF and Excel</option>
                                    </select>
                                </div>

                                <div class="mb-3" id="facilitySelection" style="display: none;">
                                    <label for="facilityName" class="form-label">Select Facility <span class="text-danger">*</span></label>
                                    <select class="form-select" id="facilityName" name="facility_name">
                                        <option value="">Choose facility...</option>
                                        {% for facility in facilities %}
                                        <option value="{{ facility.name }}">{{ facility.name }} ({{ facility.district }})</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3" id="categorySelection" style="display: none;">
                                    <label for="categoryType" class="form-label">MNCAH Category <span class="text-danger">*</span></label>
                                    <select class="form-select" id="categoryType" name="category_type">
                                        <option value="">Choose category...</option>
                                        <option value="anc">Antenatal Care (ANC) - 9 indicators</option>
                                        <option value="intrapartum">Intrapartum Care - 9 indicators</option>
                                        <option value="pnc">Postnatal Care (PNC) - 4 indicators</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Options -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card border-left-secondary">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <button type="button" class="btn btn-link text-decoration-none p-0" 
                                                    data-bs-toggle="collapse" data-bs-target="#advancedOptions">
                                                <i class="fas fa-cog me-2"></i>Advanced Options
                                                <i class="fas fa-chevron-down ms-2"></i>
                                            </button>
                                        </h6>
                                    </div>
                                    <div class="collapse" id="advancedOptions">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-lg-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Include Sections</label>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   id="includeExecutiveSummary" name="include_executive_summary" checked>
                                                            <label class="form-check-label" for="includeExecutiveSummary">
                                                                Executive Summary
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   id="includeCharts" name="include_charts" checked>
                                                            <label class="form-check-label" for="includeCharts">
                                                                Charts and Visualizations
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   id="includeRecommendations" name="include_recommendations" checked>
                                                            <label class="form-check-label" for="includeRecommendations">
                                                                Action Recommendations
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   id="includeDataQuality" name="include_data_quality" checked>
                                                            <label class="form-check-label" for="includeDataQuality">
                                                                Data Quality Assessment
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-3">
                                                        <label for="comparisonLevel" class="form-label">Comparison Level</label>
                                                        <select class="form-select" id="comparisonLevel" name="comparison_level">
                                                            <option value="none">No Comparison</option>
                                                            <option value="district">District Average</option>
                                                            <option value="national">National Average</option>
                                                            <option value="peer_facilities">Peer Facilities</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="reportLanguage" class="form-label">Report Language</label>
                                                        <select class="form-select" id="reportLanguage" name="report_language">
                                                            <option value="english">English</option>
                                                            <option value="luganda">Luganda</option>
                                                            <option value="runyankole">Runyankole</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Generate Button -->
                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary btn-lg" id="generateBtn" disabled>
                                    <i class="fas fa-file-export me-2"></i>
                                    Generate Report
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">Please select a report type and configure options above</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Reports -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Reports</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="reportsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Report Title</th>
                                    <th>Type</th>
                                    <th>Period</th>
                                    <th>Generated</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if recent_reports %}
                                    {% for report in recent_reports %}
                                    <tr>
                                        <td>{{ report.title }}</td>
                                        <td>
                                            <span class="badge bg-{% if report.type == 'comprehensive' %}primary{% elif report.type == 'category' %}success{% else %}info{% endif %}">
                                                {{ report.type.title() }}
                                            </span>
                                        </td>
                                        <td>{{ report.period }}</td>
                                        <td>{{ report.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if report.status == 'completed' %}
                                                <span class="badge bg-success">Ready</span>
                                            {% elif report.status == 'generating' %}
                                                <span class="badge bg-warning">Generating</span>
                                            {% elif report.status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if report.status == 'completed' %}
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('reports.download', id=report.id, format='pdf') }}" 
                                                   class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-file-pdf"></i>
                                                </a>
                                                {% if report.excel_available %}
                                                <a href="{{ url_for('reports.download', id=report.id, format='excel') }}" 
                                                   class="btn btn-sm btn-outline-success">
                                                    <i class="fas fa-file-excel"></i>
                                                </a>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-info view-report-btn" data-report-id="{{ report.id }}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                                            <br>
                                            No reports generated yet. Create your first MNCAH report above.
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Generation Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin me-2"></i>
                    Generating Report
                </h5>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h6 id="progressText">Initializing report generation...</h6>
                    <p class="text-muted" id="progressDetail">Please wait while we compile your MNCAH data.</p>
                    
                    <div class="progress mt-3" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedReportType = '';

    $(document).ready(function() {
        // Initialize DataTable
        $('#reportsTable').DataTable({
            "order": [[3, "desc"]],
            "pageLength": 10,
            "responsive": true
        });

        // Handle view report button clicks
        $(document).on('click', '.view-report-btn', function() {
            const reportId = $(this).data('report-id');
            viewReport(reportId);
        });

        // Handle reporting period change
        $('#reportPeriod').change(function() {
            const customDateRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
        });

        // Handle form submission
        $('#reportForm').submit(function(e) {
            e.preventDefault();
            generateReport();
        });

        // Validate form and enable/disable generate button
        $('#reportForm input, #reportForm select').on('change input', function() {
            validateForm();
        });
    });

    function selectReportType(type) {
        // Remove active class from all cards
        document.querySelectorAll('.report-card').forEach(card => {
            card.classList.remove('border-primary', 'bg-light');
        });

        // Add active class to selected card
        event.currentTarget.classList.add('border-primary', 'bg-light');

        selectedReportType = type;
        document.getElementById('reportType').value = type;

        // Show/hide relevant form sections
        const facilitySelection = document.getElementById('facilitySelection');
        const categorySelection = document.getElementById('categorySelection');

        if (type === 'facility') {
            facilitySelection.style.display = 'block';
            categorySelection.style.display = 'none';
        } else if (type === 'category') {
            facilitySelection.style.display = 'none';
            categorySelection.style.display = 'block';
        } else {
            facilitySelection.style.display = 'none';
            categorySelection.style.display = 'none';
        }

        validateForm();
    }

    function validateForm() {
        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const outputFormat = document.getElementById('outputFormat').value;
        const facilityName = document.getElementById('facilityName').value;
        const categoryType = document.getElementById('categoryType').value;

        let isValid = reportType && reportPeriod && outputFormat;

        if (reportType === 'facility') {
            isValid = isValid && facilityName;
        } else if (reportType === 'category') {
            isValid = isValid && categoryType;
        }

        const generateBtn = document.getElementById('generateBtn');
        const helpText = generateBtn.parentNode.querySelector('small');

        if (isValid) {
            generateBtn.disabled = false;
            helpText.textContent = 'Ready to generate your MNCAH report';
            helpText.className = 'text-success';
        } else {
            generateBtn.disabled = true;
            helpText.textContent = 'Please select a report type and configure options above';
            helpText.className = 'text-muted';
        }
    }

    function generateReport() {
        // Show progress modal
        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
        progressModal.show();

        // Simulate progress updates
        const progressSteps = [
            { text: 'Collecting MNCAH data...', detail: 'Gathering indicator data from database', progress: 20 },
            { text: 'Calculating indicators...', detail: 'Processing ANC, Intrapartum, and PNC metrics', progress: 40 },
            { text: 'Generating visualizations...', detail: 'Creating charts and performance summaries', progress: 60 },
            { text: 'Formatting report...', detail: 'Applying MOH styling and layout', progress: 80 },
            { text: 'Finalizing document...', detail: 'Preparing download file', progress: 100 }
        ];

        let stepIndex = 0;
        const stepInterval = setInterval(() => {
            if (stepIndex < progressSteps.length) {
                const step = progressSteps[stepIndex];
                document.getElementById('progressText').textContent = step.text;
                document.getElementById('progressDetail').textContent = step.detail;
                document.getElementById('progressBar').style.width = step.progress + '%';
                stepIndex++;
            } else {
                clearInterval(stepInterval);
                // Submit actual form
                submitReportForm();
            }
        }, 1500);
    }

    function submitReportForm() {
        const formData = new FormData(document.getElementById('reportForm'));

        $.ajax({
            url: '/reports/generate',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                progressModal.hide();

                if (response.success) {
                    MOH.showAlert('success', 'Report generated successfully!');
                    
                    // Download the report
                    if (response.download_url) {
                        window.open(response.download_url, '_blank');
                    }

                    // Refresh the page to show new report in table
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    MOH.showAlert('error', response.message || 'Report generation failed');
                }
            },
            error: function(xhr) {
                const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                progressModal.hide();

                let errorMessage = 'Report generation failed';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                MOH.showAlert('error', errorMessage);
            }
        });
    }

    function viewReport(reportId) {
        window.open(`/reports/view/${reportId}`, '_blank');
    }
</script>

<style>
.report-card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.report-card.border-primary {
    border-width: 2px !important;
}

.timeline-step {
    margin-bottom: 15px;
    padding-left: 20px;
    position: relative;
}

.timeline-step::before {
    content: '';
    position: absolute;
    left: 0;
    top: 8px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #dee2e6;
}

.timeline-step.active::before {
    background: #007bff;
}
</style>
{% endblock %}
